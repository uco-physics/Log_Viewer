<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Script Log Viewer</title>
  <!-- Bootstrap CDN: レスポンシブデザインとモダンなUI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- ansi-to-html CDN: ANSIエスケープシーケンスをHTMLに変換 -->
  <script src="https://cdn.jsdelivr.net/npm/ansi-to-html@0.7.2/lib/ansi_to_html.min.js"></script>
  <!-- xterm.js CDN: ターミナルエミュレーション（オプション） -->
  <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <style>
    /* 全体のレイアウトとモダンなデザイン */
    body {
      background-color: #f8f9fa;
      font-family: 'Roboto', sans-serif;
      padding: 20px;
    }
    .terminal-container {
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: 'Consolas', 'Courier New', monospace;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .input-section, .output-section {
      margin-bottom: 20px;
    }
    .debug-panel {
      display: none;
      background-color: #f1f1f1;
      padding: 10px;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
    }
    .debug-panel.show {
      display: block;
    }
    .progress {
      height: 20px;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      resize: vertical;
    }
    .drag-over {
      border: 2px dashed #007bff;
      background-color: #e9ecef;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Script Log Viewer</h1>

    <!-- 入力セクション -->
    <div class="input-section">
      <h3>ログ入力</h3>
      <div class="mb-3">
        <label><input type="checkbox" id="useTimestamp"> タイムスタンプを使用</label>
      </div>
      <div class="mb-3">
        <label for="logInput" class="form-label">ログファイルまたはテキスト</label>
        <div id="logDropZone" class="form-control">
          <input type="file" id="logFileInput" accept=".log,.txt" style="display: none;">
          <p class="text-muted">ここにファイルをドラッグ＆ドロップ、またはクリックして選択</p>
        </div>
        <textarea id="logInput" class="form-control mt-2" placeholder="ログをペースト"></textarea>
      </div>
      <div class="mb-3" id="timestampSection" style="display: none;">
        <label for="timestampInput" class="form-label">タイムスタンプファイルまたはテキスト</label>
        <div id="timestampDropZone" class="form-control">
          <input type="file" id="timestampFileInput" accept=".log,.txt" style="display: none;">
          <p class="text-muted">ここにファイルをドラッグ＆ドロップ、またはクリックして選択</p>
        </div>
        <textarea id="timestampInput" class="form-control mt-2" placeholder="タイムスタンプをペースト"></textarea>
      </div>
      <button id="renderButton" class="btn btn-primary">レンダリング</button>
    </div>

    <!-- 出力セクション -->
    <div class="output-section">
      <h3>出力</h3>
      <div class="progress mb-2">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
      </div>
      <div class="terminal-container" id="terminalOutput"></div>
      <div class="mt-2">
        <button id="copyPlainButton" class="btn btn-secondary">プレーンテキストをコピー</button>
        <button id="copyRawButton" class="btn btn-secondary">生ログをコピー</button>
        <button id="downloadPlainButton" class="btn btn-secondary">プレーンテキストをダウンロード</button>
        <button id="downloadRawButton" class="btn btn-secondary">生ログをダウンロード</button>
      </div>
    </div>

    <!-- デバッグパネル -->
    <div class="debug-panel" id="debugPanel">
      <h4>デバッグログ</h4>
      <div id="debugOutput"></div>
    </div>
    <button id="toggleDebugButton" class="btn btn-outline-secondary mt-2">デバッグパネルを表示/非表示</button>
  </div>

  <script>
    // グローバル変数と初期化
    const ansiToHtml = new AnsiToHTML({ escapeXML: true });
    let terminal = null;
    let rawLog = '';
    let plainLog = '';
    let debugLogs = [];

    // 初期化関数：ページ読み込み時に実行
    function initialize() {
      // XTerm.jsのターミナル初期化
      terminal = new Terminal({
        cols: 120,
        rows: 20,
        theme: { background: '#1e1e1e', foreground: '#ffffff' }
      });
      terminal.open(document.getElementById('terminalOutput'));

      // イベントリスナーの設定
      setupEventListeners();
      // リロード警告
      window.onbeforeunload = () => '入力データが失われます。';
    }

    // イベントリスナーの設定
    function setupEventListeners() {
      // タイムスタンプチェックボックス
      document.getElementById('useTimestamp').addEventListener('change', (e) => {
        document.getElementById('timestampSection').style.display = e.target.checked ? 'block' : 'none';
      });

      // ドラッグ＆ドロップとファイル選択
      setupFileInput('logDropZone', 'logFileInput', 'logInput');
      setupFileInput('timestampDropZone', 'timestampFileInput', 'timestampInput');

      // レンダリングボタン
      document.getElementById('renderButton').addEventListener('click', renderLog);

      // コピーとダウンロードボタン
      document.getElementById('copyPlainButton').addEventListener('click', () => copyToClipboard(plainLog));
      document.getElementById('copyRawButton').addEventListener('click', () => copyToClipboard(rawLog));
      document.getElementById('downloadPlainButton').addEventListener('click', () => downloadFile(plainLog, 'log_plain.txt'));
      document.getElementById('downloadRawButton').addEventListener('click', () => downloadFile(rawLog, 'log_raw.txt'));

      // デバッグパネルトグル
      document.getElementById('toggleDebugButton').addEventListener('click', () => {
        document.getElementById('debugPanel').classList.toggle('show');
      });
    }

    // ファイル入力とドラッグ＆ドロップの設定
    function setupFileInput(dropZoneId, fileInputId, textareaId) {
      const dropZone = document.getElementById(dropZoneId);
      const fileInput = document.getElementById(fileInputId);
      const textarea = document.getElementById(textareaId);

      dropZone.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', () => readFile(fileInput, textarea));
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) readFile({ files: [file] }, textarea);
      });
    }

    // ファイル読み込み
    function readFile(input, textarea) {
      const file = input.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        textarea.value = reader.result;
        logDebug(`ファイル読み込み完了: ${file.name}, サイズ: ${file.size} bytes`);
      };
      reader.onerror = () => logDebug(`ファイル読み込みエラー: ${file.name}`);
      reader.readAsText(file);
    }

    // ログのレンダリング
    async function renderLog() {
      try {
        terminal.clear();
        rawLog = document.getElementById('logInput').value;
        const timestampData = document.getElementById('useTimestamp').checked
          ? document.getElementById('timestampInput').value
          : '';
        logDebug('レンダリング開始');

        // プログレスバーの初期化
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = '0%';

        // チャンク処理
        const chunkSize = 1024 * 1024; // 1MB
        let offset = 0;
        plainLog = '';

        while (offset < rawLog.length) {
          const chunk = rawLog.slice(offset, offset + chunkSize);
          const processed = processChunk(chunk);
          plainLog += processed.plain;
          terminal.write(ansiToHtml.toHtml(processed.raw));
          offset += chunkSize;

          // プログレス更新
          const progress = Math.min(100, (offset / rawLog.length) * 100);
          progressBar.style.width = `${progress}%`;
          await new Promise(resolve => setTimeout(resolve, 10)); // 非同期でUI更新
        }

        // タイムスタンプ処理（簡略化）
        if (timestampData) {
          terminal.write(`\n[タイムスタンプデータ]\n${timestampData}`);
          logDebug('タイムスタンプデータ処理');
        }

        progressBar.style.width = '100%';
        logDebug('レンダリング完了');
      } catch (error) {
        logDebug(`レンダリングエラー: ${error.message}`);
        terminal.write(`エラー: ${error.message}`);
      }
    }

    // チャンク処理
    function processChunk(chunk) {
      // ANSIエスケープシーケンスを保持した生ログ
      const raw = chunk;
      // 制御文字を削除したプレーンテキスト
      const plain = chunk.replace(/\x1B\[[0-9;]*[a-zA-Z]/g, '')
                       .replace(/[\x00-\x1F\x7F]/g, '');
      return { raw, plain };
    }

    // クリップボードにコピー
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text)
        .then(() => logDebug('クリップボードにコピーしました'))
        .catch(err => logDebug(`コピーエラー: ${err.message}`));
    }

    // ファイルダウンロード
    function downloadFile(content, filename) {
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      logDebug(`ファイルダウンロード: ${filename}`);
    }

    // デバッグログ出力
    function logDebug(message) {
      debugLogs.push(`${new Date().toLocaleTimeString()}: ${message}`);
      console.log(message);
      const debugOutput = document.getElementById('debugOutput');
      debugOutput.innerHTML = debugLogs.join('<br>');
      debugOutput.scrollTop = debugOutput.scrollHeight;
    }

    // ページ読み込み時に初期化
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
