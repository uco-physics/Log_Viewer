<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Script Log Viewer</title>
  <!-- Bootstrap CDN: レスポンシブデザインとUIコンポーネント用 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- ansi-to-html CDN: ANSIエスケープシーケンスをHTMLに変換 -->
  <script src="https://cdn.jsdelivr.net/npm/ansi-to-html@0.7.2/lib/ansi_to_html.min.js"></script>
  <!-- xterm.js CDN: ターミナル風表示を強化 -->
  <link href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.js"></script>
  <style>
    /* 全体のレイアウトとテーマ */
    body {
      background-color: #f8f9fa;
      font-family: 'Roboto', sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
    }
    .terminal-output {
      background-color: #1e1e1e;
      color: #ffffff;
      font-family: 'Courier New', monospace;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      border-radius: 5px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .input-section, .output-section {
      margin-bottom: 20px;
    }
    .debug-panel {
      display: none;
      background-color: #f1f1f1;
      padding: 15px;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
    }
    .debug-panel.show {
      display: block;
    }
    textarea {
      font-family: 'Courier New', monospace;
      resize: vertical;
    }
    /* ドラッグ＆ドロップエリアのスタイル */
    .drop-zone {
      border: 2px dashed #007bff;
      padding: 20px;
      text-align: center;
      border-radius: 5px;
      background-color: #e9ecef;
      cursor: pointer;
    }
    .drop-zone.dragover {
      background-color: #d0e7ff;
    }
    /* プログレスバーのアニメーション */
    .progress {
      height: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Script Log Viewer</h1>
    <!-- 入力セクション -->
    <div class="input-section card p-4 mb-4">
      <h3>ログ入力</h3>
      <!-- 入力方法のトグル -->
      <div class="mb-3">
        <label class="form-label">入力方法</label>
        <div class="form-check">
          <input type="radio" class="form-check-input" name="inputMethod" id="fileInput" value="file" checked>
          <label class="form-check-label" for="fileInput">ファイルアップロード</label>
        </div>
        <div class="form-check">
          <input type="radio" class="form-check-input" name="inputMethod" id="textInput" value="text">
          <label class="form-check-label" for="textInput">テキスト入力</label>
        </div>
      </div>
      <!-- タイムスタンプのトグル -->
      <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="useTimestamp">
        <label class="form-check-label" for="useTimestamp">タイムスタンプを使用</label>
      </div>
      <!-- ログファイル入力 -->
      <div id="logFileInput" class="mb-3">
        <label for="logFile" class="form-label">ログファイル</label>
        <div class="drop-zone" id="logDropZone">ここにログファイルをドラッグ＆ドロップ</div>
        <input type="file" id="logFile" class="form-control d-none" accept=".log,.txt">
      </div>
      <!-- ログテキストエリア -->
      <div id="logTextInput" class="mb-3 d-none">
        <label for="logText" class="form-label">ログテキスト</label>
        <textarea id="logText" class="form-control" rows="5"></textarea>
      </div>
      <!-- タイムスタンプファイル入力 -->
      <div id="timestampFileInput" class="mb-3 d-none">
        <label for="timestampFile" class="form-label">タイムスタンプファイル</label>
        <div class="drop-zone" id="timestampDropZone">ここにタイムスタンプファイルをドラッグ＆ドロップ</div>
        <input type="file" id="timestampFile" class="form-control d-none" accept=".log,.txt">
      </div>
      <!-- タイムスタンプテキストエリア -->
      <div id="timestampTextInput" class="mb-3 d-none">
        <label for="timestampText" class="form-label">タイムスタンプテキスト</label>
        <textarea id="timestampText" class="form-control" rows="5"></textarea>
      </div>
      <!-- レンダリングボタン -->
      <button id="renderButton" class="btn btn-primary">レンダリング</button>
    </div>
    <!-- 出力セクション -->
    <div class="output-section card p-4">
      <h3>出力</h3>
      <!-- プログレスバー -->
      <div class="progress d-none" id="progressBar">
        <div class="progress-bar" role="progressbar" style="width: 0%;" id="progressFill"></div>
      </div>
      <!-- ターミナル出力枠 -->
      <div class="terminal-output" id="terminalOutput"></div>
      <!-- コピーとダウンロードボタン -->
      <div class="d-flex justify-content-end mt-3">
        <button id="copyPlainButton" class="btn btn-secondary me-2">プレーンテキストをコピー</button>
        <button id="copyRawButton" class="btn btn-secondary me-2">生ログをコピー</button>
        <button id="downloadPlainButton" class="btn btn-secondary me-2">プレーンテキストをダウンロード</button>
        <button id="downloadRawButton" class="btn btn-secondary">生ログをダウンロード</button>
      </div>
    </div>
    <!-- デバッグパネル -->
    <div class="debug-panel card p-3 mt-4" id="debugPanel">
      <h4>デバッグログ</h4>
      <pre id="debugLog"></pre>
    </div>
    <button class="btn btn-link" id="toggleDebug">デバッグパネルを表示/非表示</button>
  </div>

  <script>
    // グローバル変数と初期化
    const terminalOutput = document.getElementById('terminalOutput');
    const debugLog = document.getElementById('debugLog');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const ansiConverter = new AnsiToHtml(); // ansi-to-htmlインスタンス
    let terminal; // xterm.jsのインスタンス
    let logContent = ''; // ログの内容
    let timestampContent = ''; // タイムスタンプの内容
    let plainText = ''; // プレーンテキスト（制御文字除去）

    // デバッグログを追加する関数
    /**
     * デバッグメッセージをパネルとコンソールに出力
     * @param {string} message - デバッグメッセージ
     */
    function addDebugLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugLog.textContent += `[${timestamp}] ${message}\n`;
      console.log(`[${timestamp}] ${message}`);
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    // 初期化関数
    /**
     * ページ読み込み時にxterm.jsとイベントリスナーを初期化
     */
    function initialize() {
      // xterm.jsの初期化
      terminal = new Terminal({
        theme: { background: '#1e1e1e', foreground: '#ffffff' },
        fontFamily: 'Courier New, monospace',
        fontSize: 14,
      });
      terminal.open(terminalOutput);
      addDebugLog('xterm.jsを初期化しました');

      // イベントリスナーの設定
      setupEventListeners();
      addDebugLog('イベントリスナーを設定しました');
    }

    // イベントリスナーの設定
    /**
     * 各種UI要素にイベントリスナーを追加
     */
    function setupEventListeners() {
      // 入力方法のトグル
      document.querySelectorAll('input[name="inputMethod"]').forEach(radio => {
        radio.addEventListener('change', toggleInputMethod);
      });
      // タイムスタンプトグル
      document.getElementById('useTimestamp').addEventListener('change', toggleTimestampInput);
      // ドラッグ＆ドロップ
      setupDropZone('logDropZone', 'logFile');
      setupDropZone('timestampDropZone', 'timestampFile');
      // ファイル入力
      document.getElementById('logFile').addEventListener('change', handleLogFile);
      document.getElementById('timestampFile').addEventListener('change', handleTimestampFile);
      // レンダリングボタン
      document.getElementById('renderButton').addEventListener('click', renderLog);
      // コピーとダウンロード
      document.getElementById('copyPlainButton').addEventListener('click', () => copyText(plainText, 'プレーンテキスト'));
      document.getElementById('copyRawButton').addEventListener('click', () => copyText(logContent, '生ログ'));
      document.getElementById('downloadPlainButton').addEventListener('click', () => downloadText(plainText, 'log_plain.txt', 'プレーンテキスト'));
      document.getElementById('downloadRawButton').addEventListener('click', () => downloadText(logContent, 'log_raw.log', '生ログ'));
      // デバッグパネルトグル
      document.getElementById('toggleDebug').addEventListener('click', () => {
        document.getElementById('debugPanel').classList.toggle('show');
      });
      // ページ離脱時の警告
      window.onbeforeunload = () => logContent ? '変更が保存されていません。' : null;
    }

    // 入力方法の切り替え
    /**
     * ファイル入力とテキスト入力の表示を切り替え
     */
    function toggleInputMethod() {
      const method = document.querySelector('input[name="inputMethod"]:checked').value;
      document.getElementById('logFileInput').classList.toggle('d-none', method === 'text');
      document.getElementById('logTextInput').classList.toggle('d-none', method === 'file');
      addDebugLog(`入力方法を${method}に変更`);
    }

    // タイムスタンプ入力の切り替え
    /**
     * タイムスタンプ入力枠の表示/非表示を切り替え
     */
    function toggleTimestampInput() {
      const enabled = document.getElementById('useTimestamp').checked;
      document.getElementById('timestampFileInput').classList.toggle('d-none', !enabled);
      document.getElementById('timestampTextInput').classList.toggle('d-none', !enabled);
      addDebugLog(`タイムスタンプ入力を${enabled ? '有効' : '無効'}に`);
    }

    // ドラッグ＆ドロップゾーンの設定
    /**
     * ドラッグ＆ドロップのイベントを設定
     * @param {string} dropZoneId - ドロップゾーンのID
     * @param {string} inputId - 関連するファイル入力のID
     */
    function setupDropZone(dropZoneId, inputId) {
      const dropZone = document.getElementById(dropZoneId);
      dropZone.addEventListener('click', () => document.getElementById(inputId).click());
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) {
          document.getElementById(inputId).files = e.dataTransfer.files;
          document.getElementById(inputId).dispatchEvent(new Event('change'));
        }
      });
    }

    // ログファイルの処理
    /**
     * ログファイルを読み込み、テキストエリアに表示
     * @param {Event} event - ファイル入力イベント
     */
    async function handleLogFile(event) {
      try {
        const file = event.target.files[0];
        if (!file) return;
        addDebugLog(`ログファイル読み込み開始: ${file.name}`);
        logContent = await file.text();
        document.getElementById('logText').value = logContent;
        addDebugLog(`ログファイル読み込み完了: ${file.size} bytes`);
      } catch (error) {
        addDebugLog(`ログファイル読み込みエラー: ${error.message}`);
      }
    }

    // タイムスタンプファイルの処理
    /**
     * タイムスタンプファイルを読み込み、テキストエリアに表示
     * @param {Event} event - ファイル入力イベント
     */
    async function handleTimestampFile(event) {
      try {
        const file = event.target.files[0];
        if (!file) return;
        addDebugLog(`タイムスタンプファイル読み込み開始: ${file.name}`);
        timestampContent = await file.text();
        document.getElementById('timestampText').value = timestampContent;
        addDebugLog(`タイムスタンプファイル読み込み完了: ${file.size} bytes`);
      } catch (error) {
        addDebugLog(`タイムスタンプファイル読み込みエラー: ${error.message}`);
      }
    }

    // ログのレンダリング
    /**
     * ログを処理し、ターミナルに出力
     */
    async function renderLog() {
      try {
        // 入力の取得
        const inputMethod = document.querySelector('input[name="inputMethod"]:checked').value;
        logContent = inputMethod === 'file' ? logContent : document.getElementById('logText').value;
        timestampContent = document.getElementById('useTimestamp').checked ?
          (inputMethod === 'file' ? timestampContent : document.getElementById('timestampText').value) : '';

        if (!logContent) {
          addDebugLog('エラー: ログ内容がありません');
          alert('ログ内容を入力してください');
          return;
        }

        addDebugLog('レンダリング開始');
        terminal.clear();
        progressBar.classList.remove('d-none');
        progressFill.style.width = '0%';

        // チャンク処理
        const chunkSize = 1024 * 1024; // 1MB
        plainText = '';
        let processed = 0;

        for (let i = 0; i < logContent.length; i += chunkSize) {
          const chunk = logContent.slice(i, i + chunkSize);
          const html = ansiConverter.toHtml(chunk);
          plainText += stripAnsi(chunk);
          terminal.write(html);
          processed += chunk.length;
          progressFill.style.width = `${(processed / logContent.length) * 100}%`;
          await new Promise(resolve => setTimeout(resolve, 10)); // UI更新用
        }

        // タイムスタンプの処理（簡易表示）
        if (timestampContent) {
          terminal.write(`\n=== タイムスタンプ ===\n${timestampContent}`);
          addDebugLog('タイムスタンプを表示');
        }

        progressBar.classList.add('d-none');
        addDebugLog('レンダリング完了');
      } catch (error) {
        addDebugLog(`レンダリングエラー: ${error.message}`);
        alert('レンダリング中にエラーが発生しました');
      }
    }

    // ANSIエスケープシーケンスの除去
    /**
     * ログからANSIエスケープシーケンスを除去してプレーンテキストを生成
     * @param {string} text - 入力テキスト
     * @returns {string} プレーンテキスト
     */
    function stripAnsi(text) {
      return text.replace(/\u001B\[[0-9;]*[a-zA-Z]/g, '');
    }

    // テキストのコピー
    /**
     * テキストをクリップボードにコピー
     * @param {string} text - コピーするテキスト
     * @param {string} type - テキストの種類（ログ用メッセージ）
     */
    function copyText(text, type) {
      navigator.clipboard.writeText(text)
        .then(() => addDebugLog(`${type}をコピーしました`))
        .catch(err => addDebugLog(`コピーエラー: ${err.message}`));
    }

    // テキストのダウンロード
    /**
     * テキストをファイルとしてダウンロード
     * @param {string} text - ダウンロードするテキスト
     * @param {string} filename - ファイル名
     * @param {string} type - テキストの種類（ログ用メッセージ）
     */
    function downloadText(text, filename, type) {
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      addDebugLog(`${type}をダウンロードしました`);
    }

    // ページ読み込み時に初期化
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
