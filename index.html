<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Script Log Viewer</title>
  <!-- Bootstrap CDN: レスポンシブUIのためのCSSフレームワーク -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- ansi-to-html CDN: ANSIエスケープシーケンスをHTMLに変換 -->
  <script src="https://cdn.jsdelivr.net/npm/ansi-to-html@0.7.2/lib/ansi_to_html.min.js"></script>
  <!-- xterm.js CDN: ターミナル風表示（オプション） -->
  <link href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <style>
    /* 全体のスタイル: モダンなダークテーマ、ターミナル風デザイン */
    body {
      background-color: #212529;
      color: #f8f9fa;
      font-family: 'Courier New', Courier, monospace;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    /* 入力エリアのスタイル */
    .input-section {
      background-color: #343a40;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .input-section textarea {
      background-color: #495057;
      color: #f8f9fa;
      border: 1px solid #6c757d;
      resize: vertical;
      font-family: 'Courier New', Courier, monospace;
    }
    /* 出力エリア（ターミナル風） */
    #output-terminal {
      background-color: #000;
      border: 1px solid #6c757d;
      border-radius: 8px;
      padding: 10px;
      height: 400px;
      overflow-y: auto;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }
    /* デバッグパネル: 折りたたみ可能 */
    #debug-panel {
      background-color: #343a40;
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      display: none;
    }
    #debug-content {
      max-height: 200px;
      overflow-y: auto;
      background-color: #495057;
      padding: 10px;
      border-radius: 4px;
    }
    /* プログレスバー */
    #progress-bar {
      transition: width 0.3s ease;
    }
    /* レスポンシブ調整 */
    @media (max-width: 768px) {
      #output-terminal {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-center mb-4">Script Log Viewer</h1>

    <!-- 入力セクション -->
    <div class="input-section">
      <h3>ログ入力</h3>
      <div class="mb-3">
        <label for="input-type" class="form-label">入力方法</label>
        <select id="input-type" class="form-select">
          <option value="file">ファイルアップロード</option>
          <option value="text">テキスト入力</option>
        </select>
      </div>
      <!-- ファイルアップロード -->
      <div id="file-input" class="mb-3">
        <label for="log-file" class="form-label">ログファイル</label>
        <input type="file" id="log-file" class="form-control" accept=".log,.txt">
        <label for="timestamp-file" class="form-label mt-2">タイムスタンプファイル（オプション）</label>
        <input type="file" id="timestamp-file" class="form-control" accept=".log,.txt">
      </div>
      <!-- テキスト入力 -->
      <div id="text-input" class="mb-3" style="display: none;">
        <label for="log-text" class="form-label">ログテキスト</label>
        <textarea id="log-text" class="form-control" rows="5" placeholder="ログをここに貼り付け"></textarea>
        <label for="timestamp-text" class="form-label mt-2">タイムスタンプテキスト（オプション）</label>
        <textarea id="timestamp-text" class="form-control" rows="3" placeholder="タイムスタンプをここに貼り付け"></textarea>
      </div>
      <div class="form-check mb-3">
        <input type="checkbox" id="use-timestamp" class="form-check-input">
        <label for="use-timestamp" class="form-check-label">タイムスタンプを使用</label>
      </div>
      <button id="render-btn" class="btn btn-primary">レンダリング</button>
    </div>

    <!-- プログレスバー -->
    <div class="progress mb-3" style="display: none;">
      <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <!-- 出力セクション（ターミナル風） -->
    <div class="output-section">
      <h3>出力</h3>
      <div class="d-flex justify-content-end mb-2">
        <button id="copy-btn" class="btn btn-secondary me-2" disabled>コピー</button>
        <button id="download-btn" class="btn btn-secondary" disabled>ダウンロード</button>
      </div>
      <div id="output-terminal"></div>
    </div>

    <!-- デバッグパネル -->
    <div id="debug-panel">
      <h3 class="d-flex justify-content-between">
        デバッグパネル
        <button id="toggle-debug" class="btn btn-sm btn-outline-secondary">閉じる</button>
      </h3>
      <div id="debug-content"></div>
    </div>
  </div>

  <script>
    // グローバル変数: 状態管理と再利用性を考慮
    let logContent = ''; // ログの内容
    let timestampContent = ''; // タイムスタンプの内容
    let isProcessing = false; // 処理中のフラグ
    let terminal = null; // xterm.jsインスタンス
    const debugLogs = []; // デバッグログの配列
    const ansiConverter = new AnsiToHtml(); // ansi-to-htmlインスタンス

    // 初期化関数: ページロード時に実行
    function init() {
      // xterm.jsの初期化
      terminal = new Terminal({
        cols: 120,
        rows: 30,
        fontFamily: "'Courier New', Courier, monospace",
        fontSize: 14,
        theme: { background: '#000000' }
      });
      terminal.open(document.getElementById('output-terminal'));

      // イベントリスナーの設定
      document.getElementById('input-type').addEventListener('change', toggleInputMethod);
      document.getElementById('log-file').addEventListener('change', handleLogFile);
      document.getElementById('timestamp-file').addEventListener('change', handleTimestampFile);
      document.getElementById('use-timestamp').addEventListener('change', toggleTimestampInput);
      document.getElementById('render-btn').addEventListener('click', processLog);
      document.getElementById('copy-btn').addEventListener('click', copyOutput);
      document.getElementById('download-btn').addEventListener('click', downloadOutput);
      document.getElementById('toggle-debug').addEventListener('click', toggleDebugPanel);
      window.addEventListener('beforeunload', warnBeforeUnload);

      // 初期状態
      toggleInputMethod();
      toggleTimestampInput();
      logDebug('アプリケーション初期化完了');
    }

    // 入力方法の切り替え（ファイル/テキスト）
    function toggleInputMethod() {
      const inputType = document.getElementById('input-type').value;
      document.getElementById('file-input').style.display = inputType === 'file' ? 'block' : 'none';
      document.getElementById('text-input').style.display = inputType === 'text' ? 'block' : 'none';
      logDebug(`入力方法を${inputType}に切り替え`);
    }

    // タイムスタンプ入力の有効/無効
    function toggleTimestampInput() {
      const useTimestamp = document.getElementById('use-timestamp').checked;
      document.getElementById('timestamp-file').disabled = !useTimestamp;
      document.getElementById('timestamp-text').disabled = !useTimestamp;
      logDebug(`タイムスタンプ使用: ${useTimestamp}`);
    }

    // ログファイルの処理
    async function handleLogFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      try {
        logContent = await file.text();
        document.getElementById('log-text').value = logContent;
        logDebug(`ログファイル読み込み完了: ${file.name}, サイズ: ${file.size}バイト`);
      } catch (error) {
        logError(`ログファイル読み込みエラー: ${error.message}`);
      }
    }

    // タイムスタンプファイルの処理
    async function handleTimestampFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      try {
        timestampContent = await file.text();
        document.getElementById('timestamp-text').value = timestampContent;
        logDebug(`タイムスタンプファイル読み込み完了: ${file.name}, サイズ: ${file.size}バイト`);
      } catch (error) {
        logError(`タイムスタンプファイル読み込みエラー: ${error.message}`);
      }
    }

    // ログ処理のメイン関数
    async function processLog() {
      if (isProcessing) {
        logDebug('処理中です。しばらくお待ちください。');
        return;
      }
      isProcessing = true;
      terminal.clear();
      showProgress(0);

      try {
        // 入力データの取得
        const inputType = document.getElementById('input-type').value;
        if (inputType === 'text') {
          logContent = document.getElementById('log-text').value;
          timestampContent = document.getElementById('use-timestamp').checked ? document.getElementById('timestamp-text').value : '';
        }
        if (!logContent) {
          throw new Error('ログデータがありません。');
        }

        logDebug(`ログ処理開始: サイズ ${logContent.length}文字`);
        const useTimestamp = document.getElementById('use-timestamp').checked && timestampContent;

        // チャンク処理（パフォーマンス最適化）
        const chunkSize = 1024 * 10; // 10KBごと
        let currentIndex = 0;
        const totalLength = logContent.length;

        while (currentIndex < totalLength) {
          const chunk = logContent.slice(currentIndex, currentIndex + chunkSize);
          const processedChunk = processChunk(chunk, useTimestamp ? parseTimestamps(timestampContent) : null);
          terminal.write(processedChunk);
          currentIndex += chunkSize;
          showProgress((currentIndex / totalLength) * 100);
          await new Promise(resolve => setTimeout(resolve, 0)); // UI更新のための非同期処理
        }

        logDebug('ログ処理完了');
        enableOutputButtons(true);
      } catch (error) {
        logError(`ログ処理エラー: ${error.message}`);
        terminal.write(`エラー: ${error.message}\n`);
      } finally {
        isProcessing = false;
        showProgress(100);
        setTimeout(() => document.querySelector('.progress').style.display = 'none', 500);
      }
    }

    // チャンク処理: ANSIエスケープシーケンスを変換
    function processChunk(chunk, timestamps) {
      try {
        // ANSIエスケープシーケンスをHTMLに変換
        const htmlContent = ansiConverter.toHtml(chunk);
        logDebug(`チャンク処理: ${chunk.length}文字`);
        return htmlContent;
      } catch (error) {
        logError(`チャンク処理エラー: ${error.message}`);
        return chunk; // エラー時は生データを返す
      }
    }

    // タイムスタンプの解析
    function parseTimestamps(timestampData) {
      const timestamps = [];
      try {
        const lines = timestampData.split('\n').filter(line => line.trim());
        for (const line of lines) {
          const timestamp = parseFloat(line);
          if (!isNaN(timestamp)) {
            timestamps.push(timestamp);
          }
        }
        logDebug(`タイムスタンプ解析: ${timestamps.length}件`);
      } catch (error) {
        logError(`タイムスタンプ解析エラー: ${error.message}`);
      }
      return timestamps;
    }

    // プログレスバーの表示
    function showProgress(percentage) {
      const progressBar = document.getElementById('progress-bar');
      document.querySelector('.progress').style.display = 'block';
      progressBar.style.width = `${percentage}%`;
      progressBar.setAttribute('aria-valuenow', percentage);
    }

    // 出力のコピー
    function copyOutput() {
      try {
        const text = terminal.getSelection() || logContent;
        navigator.clipboard.writeText(text);
        logDebug('出力をクリップボードにコピー');
        alert('コピーしました！');
      } catch (error) {
        logError(`コピーエラー: ${error.message}`);
      }
    }

    // 出力のダウンロード
    function downloadOutput() {
      try {
        const blob = new Blob([logContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'script_log.txt';
        a.click();
        URL.revokeObjectURL(url);
        logDebug('出力をダウンロード');
      } catch (error) {
        logError(`ダウンロードエラー: ${error.message}`);
      }
    }

    // デバッグパネルの切り替え
    function toggleDebugPanel() {
      const panel = document.getElementById('debug-panel');
      const isVisible = panel.style.display === 'block';
      panel.style.display = isVisible ? 'none' : 'block';
      document.getElementById('toggle-debug').textContent = isVisible ? '開く' : '閉じる';
      logDebug(`デバッグパネル: ${isVisible ? '閉じる' : '開く'}`);
    }

    // デバッグログの記録
    function logDebug(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugLogs.push(`[DEBUG ${timestamp}] ${message}`);
      updateDebugPanel();
    }

    // エラーログの記録
    function logError(message) {
      const timestamp = new Date().toLocaleTimeString();
      debugLogs.push(`[ERROR ${timestamp}] ${message}`);
      updateDebugPanel();
    }

    // デバッグパネルの更新
    function updateDebugPanel() {
      const debugContent = document.getElementById('debug-content');
      debugContent.innerHTML = debugLogs.join('<br>');
      debugContent.scrollTop = debugContent.scrollHeight;
    }

    // ページ離脱時の警告
    function warnBeforeUnload(event) {
      if (logContent || timestampContent) {
        event.returnValue = '入力データが失われます。よろしいですか？';
        return event.returnValue;
      }
    }

    // 出力ボタンの有効/無効
    function enableOutputButtons(enabled) {
      document.getElementById('copy-btn').disabled = !enabled;
      document.getElementById('download-btn').disabled = !enabled;
    }

    // ページロード時に初期化
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
